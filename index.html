<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×¡×§×¨ ×¢×¦×™× - ×’×¨×¡×” 29.0 ×™×¦×™×‘×”</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #f0f2f5; direction: rtl; margin-bottom: 120px; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        label { display: block; margin-top: 12px; font-weight: bold; font-size: 13px; color: #333; }
        input, select { width: 100%; padding: 12px; margin-top: 4px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        .row { display: flex; gap: 8px; }
        .row > div { flex: 1; }
        button { width: 100%; padding: 16px; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .add-btn { background: #007aff; color: white; }
        .finish-btn { background: #34c759; color: white; }
        #uploadStatus { position: fixed; bottom: 80px; left: 15px; right: 15px; background: #333; color: white; padding: 10px; border-radius: 20px; font-size: 12px; display: none; text-align: center; z-index: 1000; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        #linkArea { background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px; word-break: break-all; border: 1px dashed #34c759; text-align: center; color: #1b5e20; font-weight: bold; }
    </style>
</head>
<body>

    <div id="setupStep" class="card">
        <label>×©× ×”×¤×¨×•×™×§×˜ (×ª×™×§×™×™×” ×‘×“×¨×™×™×‘):</label>
        <input type="text" id="projectName" placeholder="×œ××©×œ: ×¡×§×¨_××¨×›×–_×’×‘×¢×ª×™×™×">
        <button class="add-btn" id="startBtn" onclick="startSurvey()">×”×ª×—×œ ×¡×§×¨ ×•×¦×•×¨ ×ª×™×§×™×™×”</button>
    </div>

    <div id="surveyStep" class="hidden">
        <div id="uploadStatus">××¢×œ×” ×ª××•× ×•×ª ×‘×¨×§×¢... <span id="queueCount">0</span> × ×•×ª×¨×•</div>
        
        <div class="card">
            <h3 id="projNameDisp" style="margin:0 0 10px 0; color:#007aff;"></h3>
            
            <label>ğŸ“· ×ª××•× ×” ×¨××©×™×ª:</label>
            <input type="file" id="img1" accept="image/*" capture="camera">

            <label>××¡×¤×¨ ×”×¢×¥:</label>
            <input type="text" id="treeNum" inputmode="decimal">

            <label>×¡×•×’ ×”×¢×¥:</label>
            <input type="text" id="species" list="speciesOptions" placeholder="×”×§×œ×™×“×™ ×œ×—×™×¤×•×©...">
            <datalist id="speciesOptions">
                <option value="××‘×•×§×“×• ×××¨×™×§× ×™"><option value="××’×•×– ×”××œ×š"><option value="××’×¡ ×¡×•×¨×™"><option value="××“×¨ ××¦×•×™"><option value="××•×¨×Ÿ ×™×¨×•×©×œ×™×"><option value="××•×¨×Ÿ ×”×¦× ×•×‘×¨"><option value="××•×¨×Ÿ ×§× ×¨×™"><option value="××œ×•×Ÿ ××¦×•×™"><option value="××œ×•×Ÿ ×”×ª×‘×•×¨"><option value="×–×™×ª ××™×¨×•×¤×™"><option value="×—×¨×•×‘ ××¦×•×™"><option value="×›×œ×™×œ ×”×—×•×¨×©"><option value="×¤×™×§×•×¡ ×”×©×“×¨×•×ª"><option value="×¦××œ×•×Ÿ × ××”"><option value="×‘×¨×•×© ××¦×•×™">
                </datalist>

            <div class="row">
                <div><label>×’×•×‘×” (×')</label><input type="number" id="height" step="0.1" inputmode="decimal"></div>
                <div><label>×§×•×˜×¨ ×¦××¨×ª</label><input type="number" id="crownWidth" step="0.1" inputmode="decimal"></div>
            </div>

            <div class="row">
                <div><label>×§×•×˜×¨ ×’×–×¢ 1</label><input type="number" id="d1" step="0.1" inputmode="decimal"></div>
                <div><label>×§×•×˜×¨ ×’×–×¢ 2</label><input type="number" id="d2" step="0.1" inputmode="decimal"></div>
            </div>

            <div class="row">
                <div><label>×§×•×˜×¨ ×’×–×¢ 3</label><input type="number" id="d3" step="0.1" inputmode="decimal"></div>
                <div>
                    <label>×‘×¨×™××•×ª (0-5)</label>
                    <select id="health"><option>0</option><option>1</option><option>2</option><option>3</option><option selected>4</option><option>5</option></select>
                </div>
            </div>

            <label>×”×¢×¨×•×ª:</label>
            <input type="text" id="notes">

            <label>ğŸ“· ×ª××•× ×” × ×•×¡×¤×ª 1:</label>
            <input type="file" id="extraImg1" accept="image/*" capture="camera">

            <label>ğŸ“· ×ª××•× ×” × ×•×¡×¤×ª 2:</label>
            <input type="file" id="extraImg2" accept="image/*" capture="camera">

            <button class="add-btn" id="saveBtn" onclick="saveTree()">×©××•×¨ ×¢×¥ ×•×”××©×š ××™×“</button>
        </div>

        <div id="statusCount" style="text-align:center; font-weight:bold;">×¢×¦×™× ×©× ×¡×§×¨×•: 0</div>
        <div id="historyList" class="card"></div>

        <button class="finish-btn" id="finalBtn" onclick="finishSurvey()">×¡×™×™××ª×™ - ×”×¢×œ×” ××§×¡×œ ×•×¡×’×•×¨</button>

        <div id="resultArea" class="hidden card">
            <h3 style="color:#34c759;">×”×¡×§×¨ ×”×•×¢×œ×” ×‘×”×¦×œ×—×”!</h3>
            <div id="linkArea" onclick="copyLink()">×œ×—×¦×™ ×›××Ÿ ×œ×”×¢×ª×§×ª ×”×§×™×©×•×¨</div>
            <button onclick="location.reload()" style="background:#eee;">×¡×§×¨ ×—×“×©</button>
        </div>
    </div>

    <script>
        const GOOGLE_URL = 'https://script.google.com/macros/s/AKfycbyU5Pm9VE27UopjOYU7yWMkhaOVBWYpLSK1_Hkh17M2gCZcSJf3CrFWg6uA7bjUEEyj/exec';
        let db = []; 
        let uploadQueue = []; 
        let isUploading = false;
        let currentProject = "";

        async function startSurvey() {
            currentProject = document.getElementById('projectName').value.trim();
            if (!currentProject) return alert("× × ×œ×”×–×™×Ÿ ×©× ×¤×¨×•×™×§×˜");
            
            const btn = document.getElementById('startBtn');
            btn.disabled = true; btn.innerText = "×™×•×¦×¨ ×ª×™×§×™×™×” ×‘×“×¨×™×™×‘...";

            try {
                // ×™×¦×™×¨×ª ×ª×™×§×™×™×” ××™×™×“×™×ª ×‘×’×•×’×œ
                await fetch(GOOGLE_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({ isInit: true, projectName: currentProject }) 
                });
                
                document.getElementById('setupStep').classList.add('hidden');
                document.getElementById('surveyStep').classList.remove('hidden');
                document.getElementById('projNameDisp').innerText = "×¤×¨×•×™×§×˜: " + currentProject;
            } catch (e) {
                alert("×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×’×•×’×œ. ×•×•×“××™ ×©×”×›×ª×•×‘×ª ×ª×§×™× ×”.");
                btn.disabled = false; btn.innerText = "×”×ª×—×œ ×¡×§×¨ ×•×¦×•×¨ ×ª×™×§×™×™×”";
            }
        }

        async function processImage(file) {
            if (!file) return null;
            return new Promise(res => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 1600; // ××™×–×•×Ÿ ××•×©×œ× ×‘×™×Ÿ ××™×›×•×ª ×œ××”×™×¨×•×ª
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } }
                        else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        res(canvas.toDataURL('image/jpeg', 0.75));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function saveTree() {
            const treeNum = document.getElementById('treeNum').value;
            if (!treeNum) return alert("×—×•×‘×” ××¡×¤×¨ ×¢×¥");

            const treeData = {
                projectName: currentProject,
                treeNum: treeNum,
                species: document.getElementById('species').value,
                height: document.getElementById('height').value,
                crownWidth: document.getElementById('crownWidth').value,
                d1: document.getElementById('d1').value,
                d2: document.getElementById('d2').value,
                d3: document.getElementById('d3').value,
                health: document.getElementById('health').value,
                notes: document.getElementById('notes').value
            };

            const f1 = document.getElementById('img1').files[0];
            const ex1 = document.getElementById('extraImg1').files[0];
            const ex2 = document.getElementById('extraImg2').files[0];
            
            // ×“×—×™×¡×” ××”×™×¨×” ×‘×˜×œ×¤×•×Ÿ (×–×” ×œ×•×§×— ×©×‘×¨×™×¨ ×©× ×™×™×”)
            const uploadItem = { ...treeData };
            uploadItem.img1 = await processImage(f1);
            uploadItem.extraImages = [];
            const e1 = await processImage(ex1); if (e1) uploadItem.extraImages.push(e1);
            const e2 = await processImage(ex2); if (e2) uploadItem.extraImages.push(e2);

            uploadQueue.push(uploadItem);
            db.push(treeData); 
            
            updateUI();
            resetForm();
            processQueue(); // ××ª×—×™×œ ×œ×”×¢×œ×•×ª ×‘×¨×§×¢ ×‘×–××Ÿ ×©××ª ×¢×•×‘×¨×ª ×œ×¢×¥ ×”×‘×
        }

        async function processQueue() {
            if (isUploading || uploadQueue.length === 0) return;
            isUploading = true;
            document.getElementById('uploadStatus').style.display = 'block';
            while (uploadQueue.length > 0) {
                document.getElementById('queueCount').innerText = uploadQueue.length;
                try {
                    await fetch(GOOGLE_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        body: JSON.stringify(uploadQueue[0]) 
                    });
                    uploadQueue.shift();
                } catch (e) { await new Promise(r => setTimeout(r, 2000)); }
                document.getElementById('queueCount').innerText = uploadQueue.length;
            }
            document.getElementById('uploadStatus').style.display = 'none';
            isUploading = false;
        }

        function updateUI() {
            document.getElementById('statusCount').innerText = "×¢×¦×™× ×©× ×¡×§×¨×•: " + db.length;
            document.getElementById('historyList').innerHTML = db.slice().reverse().map((t) => `
                <div class="history-item">
                    <span><b>#${t.treeNum}</b> - ${t.species || ''}</span>
                    <span style="color: #34c759;">âœ“</span>
                </div>
            `).join('');
        }

        function resetForm() {
            ["treeNum","species","height","crownWidth","d1","d2","d3","notes","img1","extraImg1","extraImg2"].forEach(id => document.getElementById(id).value = "");
            document.getElementById('health').value = "4";
        }

        async function finishSurvey() {
            if (uploadQueue.length > 0) return alert("×”××ª×™× ×™, ×™×© ×¢×•×“ " + uploadQueue.length + " ×ª××•× ×•×ª ×©××¢×œ×•×ª ×‘×¨×§×¢...");
            const btn = document.getElementById('finalBtn');
            btn.disabled = true; btn.innerText = "×™×•×¦×¨ ××§×¡×œ ×¡×•×¤×™...";
            
            try {
                const res = await fetch(GOOGLE_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ isFinal: true, projectName: currentProject, db: db }) 
                });
                const link = await res.text();
                document.getElementById('linkArea').innerText = link;
                document.getElementById('resultArea').classList.remove('hidden');
                btn.classList.add('hidden');
            } catch(e) { 
                alert("×ª×§×œ×” ×‘×™×¦×™×¨×ª ×”××§×¡×œ. × ×¡×™ ×©×•×‘.");
                btn.disabled = false;
            }
        }

        function copyLink() {
            navigator.clipboard.writeText(document.getElementById('linkArea').innerText);
            alert("×”×§×™×©×•×¨ ×”×•×¢×ª×§!");
        }
    </script>
</body>
</html>
